<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì½” ê°€ì´ë“œ - AI ë¶„ë¦¬ìˆ˜ê±° ë„ìš°ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f0fdf4;
            font-family: 'Pretendard', sans-serif;
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #22c55e;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Markdown Table Styling */
        .markdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .markdown-table th, .markdown-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        .markdown-table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Developer Info -->
    <div class="w-full max-w-md bg-green-700 text-white py-2 px-4 rounded-b-xl text-center mb-6 shadow-md">
        <p class="text-sm font-semibold">ê°œë°œì: ê°€ì¹˜ìˆëŠ” ë¯¸ë˜êµìœ¡ì—°êµ¬ì†Œ ëŒ€í‘œ ê¹€ë³‘ì°¬</p>
    </div>

    <!-- Header -->
    <header class="w-full max-w-md text-center my-6">
        <h1 class="text-3xl font-bold text-green-700 flex items-center justify-center gap-2">
            ğŸŒ¿ ì—ì½” ê°€ì´ë“œ
        </h1>
        <p class="text-green-600 mt-2">AIê°€ ì•Œë ¤ì£¼ëŠ” ì˜¬ë°”ë¥¸ ë¶„ë¦¬ìˆ˜ê±° ë°©ë²•</p>
    </header>

    <main class="w-full max-w-md space-y-6">
        
        <!-- API Key Config Section -->
        <section class="glass-morphism p-6 rounded-2xl shadow-lg border-2 border-green-200">
            <h2 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
                ğŸ”‘ API ì„¤ì •
            </h2>
            <p class="text-xs text-gray-500 mb-3">Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì•¼ ì„œë¹„ìŠ¤ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            <div class="space-y-2">
                <input type="password" id="apiKeyInput" placeholder="ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       class="w-full px-4 py-2 border border-green-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
                <p class="text-[10px] text-green-600 text-right italic">* ì…ë ¥ëœ í‚¤ëŠ” ë¸Œë¼ìš°ì € ì„¸ì…˜ì—ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
            </div>
        </section>

        <!-- Search Section -->
        <section class="glass-morphism p-6 rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-4 text-gray-800">ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°</h2>
            <div class="flex gap-2">
                <input type="text" id="searchInput" placeholder="ì˜ˆ: í–‡ë°˜ ìš©ê¸°, ìš°ìœ íŒ©" 
                       class="flex-1 px-4 py-2 border border-green-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="analyzeText()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-bold">
                    ê²€ìƒ‰
                </button>
            </div>
        </section>

        <!-- Camera Section -->
        <section class="glass-morphism p-6 rounded-2xl shadow-lg text-center">
            <h2 class="text-lg font-semibold mb-4 text-gray-800">ì‚¬ì§„ ì°ì–´ ë¶„ì„í•˜ê¸°</h2>
            
            <div id="videoContainer" class="hidden relative mb-4">
                <video id="video" class="w-full rounded-xl bg-black" autoplay playsinline></video>
                <button onclick="captureImage()" class="mt-4 bg-green-600 text-white w-full py-3 rounded-xl font-bold">
                    ğŸ“¸ ì°°ì¹µ! ì´¬ì˜í•˜ê¸°
                </button>
            </div>

            <div id="cameraPrompt" class="space-y-4">
                <div class="w-full h-48 bg-green-50 rounded-xl border-2 border-dashed border-green-200 flex flex-col items-center justify-center text-green-600">
                    <span class="text-4xl mb-2">ğŸ“¸</span>
                    <p>ì“°ë ˆê¸°ë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ë³´ì„¸ìš”</p>
                </div>
                <button onclick="startCamera()" class="bg-green-600 text-white w-full py-3 rounded-xl font-bold hover:bg-green-700 transition">
                    ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°
                </button>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                <button onclick="document.getElementById('fileInput').click()" class="text-green-600 text-sm font-medium underline">
                    ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ
                </button>
            </div>
        </section>

        <!-- Result Section -->
        <div id="loading" class="hidden flex flex-col items-center justify-center p-8">
            <div class="loading-spinner mb-4"></div>
            <p class="text-green-700 font-medium">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <section id="resultContainer" class="hidden glass-morphism p-6 rounded-2xl shadow-lg">
            <div id="resultContent" class="text-gray-800 leading-relaxed overflow-x-auto">
                <!-- AI ê²°ê³¼ê°€ ì—¬ê¸°ì— ì‚½ì…ë¨ -->
            </div>
            <button onclick="resetApp()" class="mt-6 w-full py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition">
                ë‹¤ì‹œ í•˜ê¸°
            </button>
        </section>

    </main>

    <footer class="mt-12 text-gray-500 text-xs text-center mb-8">
        Â© 2025 ì—ì½” ê°€ì´ë“œ. ê¹¨ë—í•œ ì§€êµ¬ë¥¼ ìœ„í•´ ë…¸ë ¥í•©ë‹ˆë‹¤.<br>
        ê°€ì¹˜ìˆëŠ” ë¯¸ë˜êµìœ¡ì—°êµ¬ì†Œ
    </footer>

    <script>
        const modelName = "gemini-2.5-flash-preview-09-2025";
        let videoStream = null;

        function getApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return null;
            }
            return key;
        }

        async function callGemini(payload) {
            const userKey = getApiKey();
            if (!userKey) return null;

            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];

            while (retries < 5) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Network response was not ok');
                    }
                    return await response.json();
                } catch (error) {
                    if (retries === 4) throw error;
                    await new Promise(res => setTimeout(res, delays[retries]));
                    retries++;
                }
            }
        }

        async function analyzeText() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            const systemPrompt = "ë‹¹ì‹ ì€ í•œêµ­ì˜ ë¶„ë¦¬ë°°ì¶œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë¬¼ê±´ì˜ ë¶„ë¦¬ìˆ˜ê±° ë°©ë²•ì„ ì•ˆë‚´í•˜ì„¸ìš”. ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ í‘œ(Table) í˜•ì‹ì„ í¬í•¨í•˜ì—¬ [ë¶„ë¥˜, ë°°ì¶œë°©ë²•, ì£¼ì˜ì‚¬í•­]ì´ ëª…í™•íˆ ë³´ì´ë„ë¡ ì‘ì„±í•´ì£¼ì„¸ìš”.";
            
            showLoading(true);
            try {
                const result = await callGemini({
                    contents: [{ parts: [{ text: query }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                });
                if (result) {
                    displayResult(result.candidates?.[0]?.content?.parts?.[0]?.text);
                } else {
                    showLoading(false);
                }
            } catch (error) {
                showLoading(false);
                displayResult(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            }
        }

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                document.getElementById('videoContainer').classList.remove('hidden');
                document.getElementById('cameraPrompt').classList.add('hidden');
            } catch (err) {
                alert("ì¹´ë©”ë¼ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const base64Data = canvas.toDataURL('image/png').split(',')[1];
            stopCamera();
            analyzeImage(base64Data);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Data = e.target.result.split(',')[1];
                analyzeImage(base64Data);
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage(base64Data) {
            const userKey = getApiKey();
            if (!userKey) return;

            showLoading(true);
            const prompt = "ì´ ì‚¬ì§„ ì† ë¬¼ê±´ì„ íŒŒì•…í•˜ê³ , í•œêµ­ ë¶„ë¦¬ìˆ˜ê±° ê¸°ì¤€ì— ë§ì¶° ë°°ì¶œ ë°©ë²•ì„ ì•ˆë‚´í•˜ì„¸ìš”. ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ í‘œ(Table) í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ [ë¬¼ê±´ ì´ë¦„, ë¶„ë¦¬ë°°ì¶œ ì¢…ë¥˜, ë°°ì¶œ ë°©ë²•]ì„ ì¼ëª©ìš”ì—°í•˜ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”.";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/png", data: base64Data } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'ì´ë¯¸ì§€ ë¶„ì„ ì‹¤íŒ¨');
                }

                const result = await response.json();
                displayResult(result.candidates?.[0]?.content?.parts?.[0]?.text);
            } catch (error) {
                showLoading(false);
                displayResult(`ì´ë¯¸ì§€ ë¶„ì„ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('cameraPrompt').classList.remove('hidden');
        }

        function showLoading(isLoading) {
            document.getElementById('loading').classList.toggle('hidden', !isLoading);
            document.getElementById('resultContainer').classList.add('hidden');
            if (isLoading) {
                document.getElementById('searchInput').value = '';
            }
        }

        function parseMarkdown(text) {
            let html = text;
            const tableRegex = /\|(.+)\|(\s*\n)\s*\|([-: ]+\|)+(\s*\n)(\|(.+)\|(\s*\n?))+/g;
            html = html.replace(tableRegex, (match) => {
                const rows = match.trim().split('\n');
                let tableHtml = '<table class="markdown-table"><thead>';
                rows.forEach((row, index) => {
                    const cells = row.split('|').filter(cell => cell.trim() !== '').map(cell => cell.trim());
                    if (index === 0) {
                        tableHtml += '<tr>' + cells.map(c => `<th>${c}</th>`).join('') + '</tr></thead><tbody>';
                    } else if (index === 1) {
                    } else {
                        tableHtml += '<tr>' + cells.map(c => `<td>${c}</td>`).join('') + '</tr>';
                    }
                });
                tableHtml += '</tbody></table>';
                return tableHtml;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/### (.*?)(?:\n|$)/g, '<h3 class="text-xl font-bold text-green-800 mt-4 mb-2">$1</h3>');
            html = html.replace(/## (.*?)(?:\n|$)/g, '<h2 class="text-2xl font-bold text-green-900 mt-6 mb-3">$2</h2>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function displayResult(text) {
            showLoading(false);
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');
            content.innerHTML = parseMarkdown(text);
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function resetApp() {
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('cameraPrompt').classList.remove('hidden');
        }
    </script>
</body>
</html>
